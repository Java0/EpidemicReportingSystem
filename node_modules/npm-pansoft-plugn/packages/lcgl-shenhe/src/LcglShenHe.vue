<template>
    <el-dialog class="lcgl-songshen" :width="width" :height="height" v-if="dialogVisible" append-to-body  top="5vh"   :center="dialogCenter" :title="title"  :visible.sync="dialogVisible"  @close="distroy">
            <el-form ref="form" :model="form" label-width="80px" label-position="top" :rules="rules">
                 <!-- <el-steps class="setp_class" :space="200"  :active="active" finish-status="success" align-center>
                    <el-step :title="item.nodename"  v-for="(item, index) in nodeInfo" :key="item.nodeid">
                        <template slot="description">
                            <span v-if="index==nodeInfo.length-1"><el-link type="primary" @click="openTimeLine()">详细信息</el-link></span>
                            <span v-else>{{item.userName}}</span>
                        </template>
                    </el-step>
                </el-steps> -->
                <Steps :nodeInfo="nodeInfo" :active="active" :onOk="openTimeLine"></Steps>
                <TimeLine v-if="timeLineShow" :title="timeLine.title" :dialogShow.sync="timeLineShow" :activities="activities"></TimeLine>
                 <el-form-item label="办理人" >
                    <el-input class="spr_class" v-model="form.approveName" @click.native="openRyDialog()" placeholder="请选择下一办理人" :readonly="readOnly"></el-input>
                </el-form-item>
                  <el-form-item label="审核意见" prop="comment">
                    <el-input class="spr_class"  type="textarea" :rows="2" v-model="form.comment" placeholder="请输入审核意见"></el-input>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <div style="text-align:center;padding: 10px 0">
                    <el-button type="primary" @click="submit()">{{okBtText}}</el-button>
                    <el-button  @click="back">{{backBtText}}</el-button>
                    <el-button  @click="distroy">{{canelBtText}}</el-button>
                </div>
            </div>
            <SelTysqSingleRyYhzx 
                ref="SelTysqSingleRyYhzx"
                v-if="showSingelRy"
                :tysqShow.sync="showSingelRy" 
                :dataOptions="dataOptions"
                :dwTreeParams="dwTreeParams"
                :onOk="selSingelRy"
                :isLoading="isLoading"></SelTysqSingleRyYhzx>
    </el-dialog>
</template>

<script>
import Steps from "./Steps";
export default {
    name:"LcglShenHe",
    components: {
        Steps
    },data(){
        return{
            readOnly:true,
            dialogVisible:this.dialogShow,
            timeLineShow:false,
            form:{
                approveName:"",
                approveId:"",
                comment:"",
                workId:this.workId,
                trackId:this.trackId,
                subjection:this.subjection,
                tenantCode:this.tenantCode,
                djid:this.djid
            },
            nodeParms:{
                flowId:this.flowId,
                workId:this.workId,
                trackId:this.trackId,
                subjection:this.subjection,
                tenantCode:this.tenantCode
            },
            dwTreeParams:{
                dwbm:"CNPC.PetroChina.TLM",
                maxdwjb:"100",
                mindwjb:"0",
                order:"DWBM",
                dwid:"",
                tysqversion:"1.0"
            },
            showSingelRy:false,
            dataOptions:{
                retData:[]
            },
            rules:{
                comment:[{required: true, message: '请输入', trigger: 'blur'}]
            },
            flowUser:{},
            nodeInfo:[],
            flowInfo:[],
            endNode:false,
            timeLine:{
                title:"审核记录"
            }
        }
    },
    created(){
        this.getNodeList();
    },
    computed:{
        active(){
            if(this.nodeInfo.length==1){
                return 0;
            }else{
                return this.nodeInfo.length-1;
            }
        },
        activities(){
            let ret=[];
            if(Object.keys(this.flowInfo).length>0){
                for(var key in this.flowInfo){
                    let temp={};
                    temp.content="<h style='color:red'>"+this.flowInfo[key].userName+"</h> 在 <h style='color:#409eff'>"+this.flowInfo[key].nodeName+"</h> 节点进行了 <h style='color:#69aa46'>"+this.flowInfo[key].actionname +"</h> 操作，操作内容："+this.flowInfo[key].memo+
                                "</br> <a class='el-icon-chat-line-square'></a> 意见: "+this.flowInfo[key].comments;
                    temp.timestamp=this.flowInfo[key].actiontime;
                    temp.size= 'large';
                    temp.type= 'primary';
                    temp.icon= 'el-icon-more';
                    ret.push(temp);
                }
            }
            return ret;
        }
    },
    watch:{
        dialogShow () {
            //此处是关键
            this.dialogVisible = this.dialogShow;
        }
    },
    props:{
        dialogShow:{
            type:Boolean,
            default:false,
        },
        okBtText:{
            type:String,
            default:"确 定"
        },
        backBtText:{
            type:String,
            default:"退 回"
        },
        canelBtText:{
            type:String,
            default:"取 消"
        },
        flowId:{
            type:String,
            default:""
        },
        workId:{
            type:String,
            default:""
        },
        trackId:{
            type:String,
            default:""
        },
        submitFun:{
            type:String,
            default:""
        },
        backFun:{
            type:String,
            default:""
        },
        tenantCode:{
            type:String,
            default:"system"
        },
        subjection:{
            type:String,
            default:""
        },
        title:{
            type:String,
            default:"审批"
        },
        width:{
            type:String,
            default:"520px"
        },
        height:{
            type:String,
            default:"400px"
        },
        onOk:{
            type:Function,
            default:()=>{}
        },
        dialogCenter:{
            type:Boolean,
            default:true,
        },
        params:{
            type:Object,
            default:()=>{}
        },
        djid:{
            type:String,
            default:""
        }
    },
    methods:{
        getNodeList(){
            let that = this;
            this.axios.apiPost({
                url:"/hzworkflow/getNodeInfo",
                data:this.nodeParms,
                call:function(res){
                    // console.log(res);
                    if(res.data.flag){
                        that.flowUser=res.data.flowUser;
                        that.nodeInfo=res.data.nodeInfo;
                        that.flowInfo=res.data.flowInfo;
                        if(res.data.endNode){
                            that.endNode=res.data.endNode;
                        }
                    }
                }
            });
        },
        getNodeInfo(){

        },
        distroy(){
            this.$emit('update:dialogShow', false);
        },
        submit(){
            this.$refs["form"].validate((valid) => {
                if (!valid) {         
                  
                }else{
                    let that = this;
                    const loading = this.$loading({
                        lock: true,
                        text: `加载中……`,
                        spinner: "el-icon-loading"
                    });
                    this.axios.apiPost({
                        url:this.submitFun,
                        data:this.form,
                        call:function(res){
                            if(res.data.flag){
                                that.onOk(res);
                                that.distroy();
                                // console.log(res.data);
                                loading.close();
                            }else{
                                loading.close();
                                that.$message({
                                    type: "succee",
                                    message: res.data.msg
                                });
                            }
                        }
                    });
                }
            });
        },
        back(){
            //退回 判断
            if(this.nodeInfo.length<3){
                this.$message({
                    type: "error",
                    message: "当前节点为申请人节点，无法退回!"
                });
            }else{
                this.$refs["form"].validate((valid) => {
                    if (!valid) {         
                    
                    }else{
                        let that = this;
                        const loading = this.$loading({
                            lock: true,
                            text: `加载中……`,
                            spinner: "el-icon-loading"
                        });
                        this.axios.apiPost({
                            url:this.backFun,
                            data:this.form,
                            call:function(res){
                                that.onOk(res);
                                that.distroy();
                                // console.log(res.data);
                                loading.close();
                            }
                        });
                    }
                });
            }
        },
        openRyDialog(){
            this.showSingelRy=true;
        },
        selSingelRy(data){
            this.form.approveName=data.EMPLOYEE_NAME;
            this.form.approveId=data.EMPLOYEE_ID;
            // console.log(data);
        },
        openTimeLine(){
            this.timeLineShow=true;
        }
    }
}
</script>

<style scoped>
    .spr_class>>>.el-input__inner{
        cursor: pointer;
    }
    /* .setp_class>>>.el-step__head.is-success{
        color: #66b1ff;
        border-color: #66b1ff;
    }
    .setp_class>>>.el-step__title.is-success{
        color: #66b1ff;
    }
    .setp_class>>>.el-step__description.is-success{
        color: #66b1ff;
    }
    .setp_class{
        justify-content:center;
    } */
</style>