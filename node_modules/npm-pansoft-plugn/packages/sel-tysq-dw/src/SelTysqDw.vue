<template>
    <el-dialog class="selDwDg" :width="dialogWidth" v-if="dialogTysqVisible" append-to-body top="5vh"   :center="dialogOp.center" title="选择单位"  :visible.sync="dialogTysqVisible"  @close="distroy">
        <ContentMain :footerHeight="height">
            <template>
                  <el-input placeholder="输入关键字进行过滤" v-model="filterText"> </el-input>
                        <el-tree ref="tree"  
                        class="filter-tree"
                        :props="treeProps"
                        @node-click="handleNodeClick" 
                        :load="loadNode"
                        lazy
                        :filter-node-method="filterNode"
                        :expand-on-click-node="true"
                        v-if="dialogTysqVisible"
                        accordion></el-tree>
            </template>
            <template slot="footer">
                <div style="text-align:center;padding: 10px 0">
                    <el-button type="primary" @click="doSave">保 存</el-button>
                    <el-button  @click="distroy">取 消</el-button>
                </div>
            </template>
        </ContentMain>
    </el-dialog>
</template>

<script>
import {mapGetters} from "vuex";
import {deepClone,jsonTree,mergeArray,isEmpty} from "npm-pansoft-base/lib/utils/util";

export default {
    name:"SelTysqDw",
    data() {
      return {
        height:'60px',
        filterText: '',
        dialogTysqVisible: this.tysqDwShow,
        dialogOp:{
            center : false
        },
        myDwTreeParams:{
            dwbm:this.dwTreeParams.dwbm,
            maxdwjb:this.dwTreeParams.maxdwjb,
            mindwjb:this.dwTreeParams.mindwjb,
            order:this.dwTreeParams.order,
            dwid:this.dwTreeParams.dwid,
        },
        treeData:[],
        treeProps: {
          children: 'children',
          label: 'label',
          isLeaf: 'leaf'
        }
      }
    },
    created() {
    },
    mounted(){
        if(this.dwTreeParams.tysqversion=="1.0"){
            this.myDwTreeParams.dwbm=this.dwTreeParams.dwbm;
            this.myDwTreeParams.order="DWPWSX";
            
        }else{
            this.myDwTreeParams.dwid=this.dwTreeParams.dwid;
            this.myDwTreeParams.order="DWBM";
        }
    },
    props: {
        tysqDwShow: {
            type: Boolean,
            default: false
        },dataOptions:{
            type: Object,
            default:() =>{}
        },dwTreeParams:{
            type:Object,
            default:()=>{
                return {
                    dwbm:"CNPC.PetroChina.TLM",
                    maxdwjb:"100",
                    mindwjb:"0",
                    order:"DWPWSX",
                    dwid:"",
                    tysqversion:"1.0"
                } 
            }
        },dialogWidth:{
            type:String,
            default:"500px"
        },
        onOk:{
            type:Function,
            default:()=>{}
        }
    },
    watch: {
        tysqDwShow () {
            //此处是关键
            this.dialogTysqVisible = this.tysqDwShow;
        },
        filterText(val) {
            this.$refs.tree.filter(val);
        }
    },
    computed:{
    },
    methods: {
        getDwtree(resolve){
            var that=this;
            this.axios.apiPost({
                url:'/tysq/queryDwTreeByNoSync',
                data:this.myDwTreeParams,
                call:function(res){
                    let tree=jsonTree(res.data,{
                            id: 'id',
                            pid: 'pid',
                            children: 'children'
                    });
                    // console.log(tree);
                    tree.forEach(item=>{
                        if(item.state=="open"){
                            item.leaf=true;
                        }
                    })
                    resolve(tree);
                }
            });
        },
        canel(){
            this.dialogTysqVisible=false;
            //重置数据无效 this.$refs.avueForm.resetForm();
        },
        distroy(){
            this.$emit('update:tysqDwShow', false);
        }, 
        filterNode(value, data) {
            if (!value) return true;
            return data[this.treeProps.label].indexOf(value) !== -1;
        },
        handleNodeClick(data){
            this.treeData=data;
        },
        doSave(){
            if(this.treeData.length==0){
                this.$message.error("请选择单位！");
            }else{
                this.dataOptions.retData=deepClone(this.treeData);
                this.onOk(deepClone(this.treeData));
                //this.$emit("sendData", this.rightRyData);
                this.distroy();
            }
        },
        loadNode(node, resolve){
            if (node.level === 0) {
                this.getDwtree(resolve);
            }else{
                this.myDwTreeParams.id=node.data.id;
                this.getDwtree(resolve);
            }
        }
    }
}
  //显示组件不要用avue 来封装
</script>
<style scoped>
  .el_input_search {
    width: 120px !important;
  }
  .el-header{
      padding:0 5px
  }
  .selDwDg>>>.mainDg{
      height: 400px;
  }
</style>