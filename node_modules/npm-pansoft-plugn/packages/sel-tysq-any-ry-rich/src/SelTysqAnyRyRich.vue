<template>
    <el-dialog v-if="dialogTysqVisible" append-to-body :width="dialogWidth" top="5vh"   :center="dialogOp.center" title="选择人员(多选)"  :visible.sync="dialogTysqVisible"  @close="distroy">
        <!--父组件传过来的formData 赋值给新值newFormData 如果不赋值控制台会报错 经过努力 avue的方式传值有问题 js会报错 其实没有错 官方插件bug-->
            <el-container style="height: 500px; border: 1px solid #eee">
                <el-aside width="300px" style="background-color: rgb(238, 241, 246)">
                        <el-input placeholder="输入关键字进行过滤" v-model="filterText"> </el-input>
                        <el-tree ref="tree"
                        v-loading="loading"
                        class="filter-tree"
                        :data = "treeData"
                        :props="treeProps"
                        @node-click="handleNodeClick"
                        :filter-node-method="filterNode"
                        v-if="dialogTysqVisible"
                        :expand-on-click-node="true"
                        accordion></el-tree>
                </el-aside>
                <el-container>
                     <el-header style="height: auto; font-size: 12px">
                        <div style="text-align: left;float:left">
                            <el-tag type="success"> 可选人员</el-tag>
                        </div>
                        <div style="text-align: right;" class="seach_div">
                            <el-input class="el_input_search" @keyup.enter.native="gteRyByXm" v-model="inputParams.loginCode" size="mini" placeholder="请输入登陆id"/>
                            <el-input class="el_input_search" @keyup.enter.native="gteRyByXm" v-model="inputParams.userName"  size="mini" placeholder="请输入用户姓名"/>
                            <el-tooltip class="item" effect="dark" content="搜索" placement="top">
                                <el-button type="default" icon="el-icon-search" circle size="mini" @click="gteRyByXm()"></el-button>
                            </el-tooltip>
                            <el-tooltip class="item" effect="dark" content="清除" placement="top">
                                <el-button type="default" icon="el-icon-refresh-right" circle size="mini" @click="clear()"></el-button>
                            </el-tooltip>
                            <el-tooltip class="item" effect="dark" content="全部选择" placement="top">
                                <el-button type="default" icon="el-icon-d-arrow-right" circle size="mini" @click="choseAll()"></el-button>
                            </el-tooltip>
                        </div>
                    </el-header >
                    <el-main>
                         <el-table :data="leftRyData" style="width: 100%" @row-dblclick="selRy" height="400"> 
                             <el-table-column
                                label="序号"
                                type="index"
                                width="50">
                            </el-table-column>
                             <el-table-column
                                prop="userName"
                                label="姓名"
                                width="180">
                            </el-table-column>
                            <el-table-column
                                prop="deptName"
                                label="单位名称"
                                width="160">
                            </el-table-column>
                        </el-table>
                    </el-main>
                </el-container>
                 <el-container>
                    <el-header style="height: auto;text-align: right; font-size: 12px">
                         <div style="text-align: left;float:left">
                            <el-tag> 已选人员</el-tag>
                        </div>
                        <div style="text-align: right;">
                           <el-button type="default" icon="el-icon-d-arrow-left" circle size="mini" @click="clearAll()"></el-button>
                        </div>
                    </el-header >
                    <el-main>
                        <el-table :row-class-name="tableRowClassName" :data="rightRyData" style="width: 100%" @row-dblclick="unSelRy" height="420"> 
                            <el-table-column
                                label="序号"
                                type="index"
                                width="50">
                            </el-table-column>
                            <el-table-column
                                prop="userName"
                                label="姓名"
                                width="180">
                            </el-table-column>
                            <el-table-column
                                prop="deptName"
                                label="单位名称"
                                width="160">
                            </el-table-column>
                        </el-table>
                    </el-main>
                </el-container>
            </el-container>
            <el-footer>
                 <div style="text-align:center;padding: 10px 0">
                    <el-button type="primary" @click="doSave">保 存</el-button>
                    <el-button  @click="distroy">取 消</el-button>
                </div>
            </el-footer>
    </el-dialog>
</template>

<script>
import {mapGetters} from "vuex";
import {deepClone,jsonTree,mergeArray,isEmpty} from "npm-pansoft-base/lib/utils/util";

export default {
    name:"SelTysqAnyRyRich",
    data() {
      return {
        filterText: '',
        dialogTysqVisible: this.tysqShow,
        dialogOp:{
            center : false
        },
        inputParams:{
            yhxm:"",
            dlid:""
        },
        myDwTreeParams:{
            dwbm:this.dwTreeParams.dwbm,
            maxdwjb:this.dwTreeParams.maxdwjb,
            mindwjb:this.dwTreeParams.mindwjb,
            order:this.dwTreeParams.order,
            dwid:this.dwTreeParams.dwid,
        },
        leftRyData:[],
        rightRyData:[],
        treeData:[],
        treeProps: {
          children: 'children',
          label: 'deptName',
          isLeaf: 'leaf'
        }
      }
    },
    created() {
        if(this.backConfig.tysqversion=="1.0"){
            this.myDwTreeParams.dwbm=this.dwTreeParams.dwbm;
            this.myDwTreeParams.order="DWPWSX";
            
        }else{
            this.myDwTreeParams.dwid=this.dwTreeParams.dwid;
            this.myDwTreeParams.order="DWBM";
        }
        this.getDwList();
    },
    mounted(){
        
    },
    props: {
        tysqShow: {
            type: Boolean,
            default: false
        },dataOptions:{
            type: Object,
            default:() =>{}
        },dwTreeParams:{
            type:Object,
            default:()=>{
                return {
                    dwbm:"CNPC.PetroChina.TLM",
                    maxdwjb:"100",
                    mindwjb:"0",
                    order:"DWPWSX",
                    dwid:""
                } 
            }
        },
        onOk:{
            type:Function,
            default:()=>{}
        },
        dialogWidth:{
            type:String,
            default:"1300px"
        },
        isLoading:{
            type: Boolean,
            default: true
        }
    },
    watch: {
        tysqShow () {
            //此处是关键
            this.dialogTysqVisible = this.tysqShow;
        },
        filterText(val) {
            this.$refs.tree.filter(val);
        }
    },
    computed:{
        ...mapGetters(["backConfig"]),
        loading(){
          if(isEmpty(this.treeData)&&this.isLoading){
            return true;
          }else{
            return false;
          }
        }
    },
    methods: {
         getDwList(){
            var that = this;
            this.axios.apiGet({
                url: "/privilege/dept/list",
                data:{filter: ""},
                call:function(res){
                    // console.log(res);
                    let tree=jsonTree(res.data.result,{
                        id: 'deptId',
                        pid: 'deptPId',
                        children: 'children'
                    });
                    // console.log(tree);
                    tree.forEach(item=>{
                        if(item.state=="open"){
                            item.leaf=true;
                        }
                        that.treeData = tree;
                    })
                }
            });
        },
        getRyByDw(){
           this.getRyData();
        },
        gteRyByXm(){
            let filters = [];
            if(!isEmpty(this.inputParams.userName)){
                let temp={operator: "like", value:this.inputParams.userName, property: "userName"};
                filters.push(temp);
            }
            if(!isEmpty(this.inputParams.loginCode)){
                let temp={operator: "like", value:this.inputParams.loginCode, property: "loginCode"};
                filters.push(temp);
            }
            this.inputParams.filter=JSON.stringify(filters);
            this.getRyData();
        },
        clear(){
            this.inputParams.userName="";
            this.inputParams.loginCode="";
            this.inputParams.filter="";
            this.getRyData();
        },
        canel(){
            this.dialogTysqVisible=false;
            //重置数据无效 this.$refs.avueForm.resetForm();
        },
        distroy(){
            this.$emit('update:tysqShow', false);
            //关闭的时候重置
            this.rightRyData = [];
            this.leftRyData = [];
        }, 
        filterNode(value, data) {
            if (!value) return true;
              return data[this.treeProps.label].indexOf(value) !== -1;
        },
        handleNodeClick(data){
            let filters = [];
            let filter = {operator: "eq", value:data.deptId, property: "deptId"};
            filters.push(filter);
            this.inputParams.filter = JSON.stringify(filters);
            this.getRyByDw();
        },
        choseAll(){
            this.rightRyData=mergeArray(deepClone(this.rightRyData),deepClone(this.leftRyData),"loginId");
        },
        clearAll(){
            this.rightRyData=[];
        },
        selRy(row, event){
            let rows=this.rightRyData;
            for(var x in rows){
                if(rows[x].loginId == row.loginId){
                    this.$message.error("请勿重复添加！");
                    return;
                }
            }
            this.rightRyData.push(row);
        },
        unSelRy(row, event){
            this.rightRyData.splice(row.index,1);
        },
        doSave(){
            if(this.rightRyData.length==0){
                this.$message.error("请选择人员！");
            }else{
                this.dataOptions.retData=deepClone(this.rightRyData);
                this.onOk(deepClone(this.rightRyData));
                //this.$emit("sendData", this.rightRyData);
                this.distroy();
            }
        },
        tableRowClassName({row, rowIndex}) {
            row.index=rowIndex;
        },
        getRyData(){
            if(isEmpty(this.inputParams.filter)){
                let filters = [];
                let temp={operator: "eq", value:"", property: "deptId"};
                filters.push(temp);
                this.inputParams.filter=JSON.stringify(filters);
                this.inputParams.deptId = "1";
            }
            var that=this;
            this.axios.apiGet({
                url:'/Otherdata/getotherdata/listUserDept',
                data:this.inputParams,
                call:function(res){
                    if(res.data.success){
                        that.leftRyData=res.data.result;
                    }
                }
            });
        }
    }
}
  //显示组件不要用avue 来封装
</script>
<style scoped>
  .seach_div>>>.el_input_search {
    width: 120px !important;
  }
  .el-header{
      padding:0 5px
  }
</style>