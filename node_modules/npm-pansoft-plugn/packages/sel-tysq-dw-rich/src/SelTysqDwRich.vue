<template>
  <el-dialog class="selDwDg" :width="dialogWidth" v-if="dialogTysqVisible" append-to-body top="5vh"   :center="dialogOp.center" title="选择单位"  :visible.sync="dialogTysqVisible"  @close="distroy">
    <ContentMain :footerHeight="footerHeight">
      <template>
        <el-input placeholder="输入关键字进行过滤" v-model="filterText"> </el-input>
        <el-tree ref="tree"
                  v-loading="loading"
                 class="filter-tree"
                 :data = "treeData"
                 :props="treeProps"
                 @node-click="handleNodeClick"
                 :filter-node-method="filterNode"
                 v-if="dialogTysqVisible"
                 accordion></el-tree>
      </template>
      <template slot="footer">
        <div style="text-align:center;padding: 10px 0">
          <el-button type="primary" @click="doSave">保 存</el-button>
          <el-button  @click="distroy">取 消</el-button>
        </div>
      </template>
    </ContentMain>
  </el-dialog>
</template>

<script>
  import {mapGetters} from "vuex";
  import {deepClone,jsonTree,mergeArray,isEmpty} from "npm-pansoft-base/lib/utils/util";

  var order="DWBM";
  export default {
    name:"SelTysqDwRich",
    data() {
      return {
        footerHeight:'60px',
        filterText: '',
        dialogTysqVisible: this.tysqDwShow,
        dialogOp:{
          center : false
        },
        myDwTreeParams:{
          dwbm:this.dwTreeParams.dwbm,
          maxdwjb:this.dwTreeParams.maxdwjb,
          mindwjb:this.dwTreeParams.mindwjb,
          order:this.dwTreeParams.order,
          dwid:this.dwTreeParams.dwid,
        },
        treeData:[],
        treeDwData:[],
        treeProps: {
          children: 'children',
          label: 'deptName',
          isLeaf: 'leaf'
        }
      }
    },
    created() {
      if(this.backConfig.tysqversion=="1.0"){
        this.myDwTreeParams.dwbm=this.dwTreeParams.dwbm;
      }else{
        this.myDwTreeParams.order=this.dwTreeParams.order;
        this.myDwTreeParams.dwid=this.dwTreeParams.dwid;
      }
    },
    mounted(){
      var that = this;
      this.axios.apiGet({
        url: "/privilege/dept/list",
        data:{filter: ""},
        call:function(res){
          // console.log(res);
          let tree=jsonTree(res.data.result,{
            id: 'deptId',
            pid: 'deptPId',
            children: 'children'
          });
          // console.log(tree);
          tree.forEach(item=>{
            if(item.state=="open"){
              item.leaf=true;
            }
            that.treeData = tree;
          })
        }
      });
    },
    props: {
      tysqDwShow: {
        type: Boolean,
        default: false
      },dataOptions:{
        type: Object,
        default:() =>{}
      },dwTreeParams:{
        type:Object,
        default:()=>{
          return {
            dwbm:"CNPC.PetroChina.TLM",
            maxdwjb:"100",
            mindwjb:"0",
            order:order,
            dwid:""
          }
        }
      },dialogWidth:{
        type:String,
        default:"500px"
      },
      onOk:{
        type:Function,
        default:()=>{}
      },
      height:{
        type:String,
        default:'600px'
      },
      width:{
        type:String,
        default:'500px'
      },
      isLoading:{
          type: Boolean,
          default: true
      }
    },
    watch: {
      tysqDwShow () {
        //此处是关键
        this.dialogTysqVisible = this.tysqDwShow;
      },
      filterText(val) {
        this.$refs.tree.filter(val);
      }
    },
    computed:{
      ...mapGetters(["backConfig"]),
      loading(){
        if(isEmpty(this.treeData)&&this.isLoading){
          return true;
        }else{
          return false;
        }
      }
    },
    methods: {
      getDwtree(resolve){
        var that=this;
        var filter = {operator: "like", value:this.myDwTreeParams.id, property: "deptCode"};
        var filters = [];
        filters.push(filter);
        this.axios.apiGet({
          url: "/privilege/dept/list",
          data:{filter: filters},
          call:function(res){
            let tree=jsonTree(res.data.result,{
              id: 'deptId',
              pid: 'deptPId',
              children: 'children'
            });
            tree.forEach(item=>{
              if(item.state=="open"){
                item.leaf=true;
              }
            })
            resolve(tree);
          }
        });
      },
      canel(){
        this.dialogTysqVisible=false;
        //重置数据无效 this.$refs.avueForm.resetForm();
      },
      distroy(){
        this.$emit('update:tysqDwShow', false);
      },
      filterNode(value, data) {
        if (!value) return true;
          return data[this.treeProps.label].indexOf(value) !== -1;
      },
      handleNodeClick(data){
        // console.log("handleNodeClick", data)
        this.treeDwData=data;
      },
      doSave(){
        if(this.treeDwData.length==0){
          this.$message.error("请选择单位！");
        }else{
          this.dataOptions.retData=deepClone(this.treeDwData);
          this.onOk(deepClone(this.treeDwData));
          //this.$emit("sendData", this.rightRyData);
          this.distroy();
        }
      },
      loadNode(node, resolve){
        if (node.level === 0) {
          this.getDwtree(resolve);
        }else{
          this.myDwTreeParams.id=node.data.deptCode;
          this.getDwtree(resolve);
        }
      }
    }
  }
  //显示组件不要用avue 来封装
</script>
<style scoped>
  .el_input_search {
    width: 120px !important;
  }
  .el-header{
    padding:0 5px
  }
  .selDwDg>>>.mainDg{
    height: 400px;
  }
</style>
